
{% extends "base.html" %}

{% block title %}Figab Capital Partners — Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
{% endblock %}

{% block page_title_bar %}
<div class="page-title-bar">
  <div class="page-title-inner">
    <div class="page-title-cell">
      <span class="page-eyebrow">Restricted</span>
      <h1>Admin</h1>
    </div>
    <span class="admin-badge">Authenticated</span>
  </div>
</div>
{% endblock %}

{% block body %}
<main>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        <div class="flash-bar">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ══════════════════════════════════
       01 · TRANSACTION LEDGER
       ══════════════════════════════════ -->
  <section class="admin-section">
    <div class="section-header">
      <span class="section-num">01</span>
      <span class="section-title">Transaction Ledger</span>
      <span class="section-meta">{{ transactions | length }} records · transactions.csv</span>
    </div>

    <div class="tx-filter-bar">
      <input type="text" id="tx-search" placeholder="Filter by ticker, type, date…" oninput="filterTable()" />
      <select id="tx-type-filter" onchange="filterTable()">
        <option value="">All types</option>
        <option value="Buy">Buy</option>
        <option value="Sell">Sell</option>
        <option value="Short">Short</option>
      </select>
      <span class="tx-count" id="tx-visible-count">{{ transactions | length }} shown</span>
    </div>

    <div class="tx-table-wrap">
      <table id="tx-table">
        <thead>
          <tr>
            <th onclick="sortTable(0)"><span>#</span><span class="sort-arrow">↕</span></th>
            <th onclick="sortTable(1)">Ticker<span class="sort-arrow">↕</span></th>
            <th onclick="sortTable(2)">Date<span class="sort-arrow">↕</span></th>
            <th onclick="sortTable(3)">Type<span class="sort-arrow">↕</span></th>
            <th onclick="sortTable(4)">Amount<span class="sort-arrow">↕</span></th>
            <th onclick="sortTable(5)">Price<span class="sort-arrow">↕</span></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tx-body">
          {% for tx in transactions %}
          <tr data-row="{{ loop.index0 }}">
            <td class="row-idx">{{ loop.index }}</td>
            <td class="ticker">{{ tx.Ticker }}</td>
            <td>{{ tx.Date }}</td>
            <td class="type-{{ tx.Type | lower }}">{{ tx.Type }}</td>
            <td class="amount">{{ tx.Amount }}</td>
            <td class="price">{{ tx.Price if tx.Price else '—' }}</td>
            <td>
              <form method="post" action="/admin/delete_transaction" style="display:inline;"
                    onsubmit="return confirm('Delete {{ tx.Ticker }} {{ tx.Type }} on {{ tx.Date }}?')">
                <input type="hidden" name="row_index" value="{{ loop.index0 }}" />
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- ══════════════════════════════════
       02 · ADD TRANSACTION
       ══════════════════════════════════ -->
  <section class="admin-section">
    <div class="section-header">
      <span class="section-num">02</span>
      <span class="section-title">Add Transaction</span>
    </div>
    <div class="section-body">
      <form method="post" action="/admin/add_transaction">
        <div class="form-grid">
          <div class="form-field">
            <label for="ticker">Ticker</label>
            <input type="text" id="ticker" name="ticker" placeholder="e.g. AAPL" required />
          </div>
          <div class="form-field">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" required />
          </div>
          <div class="form-field">
            <label for="action">Type</label>
            <select id="action" name="action" required>
              <option value="Buy">Buy</option>
              <option value="Sell">Sell</option>
              <option value="Short">Short</option>
            </select>
          </div>
          <div class="form-field">
            <label for="amount">Amount</label>
            <input type="number" id="amount" name="amount" min="1" placeholder="e.g. 50" required />
          </div>
          <div class="form-field">
            <label for="price">Price (optional)</label>
            <input type="number" id="price" name="price" step="0.001" placeholder="e.g. 125.50" />
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Record Transaction</button>
          <button type="reset" class="btn btn-ghost">Clear</button>
        </div>
      </form>
    </div>
  </section>

  <!-- ══════════════════════════════════
       03 · UPLOAD REPORT
       ══════════════════════════════════ -->
  <section class="admin-section">
    <div class="section-header">
      <span class="section-num">03</span>
      <span class="section-title">Upload Report</span>
    </div>
    <div class="section-body">
      <form action="/success" method="post" enctype="multipart/form-data">
        <div class="form-grid">
          <div class="form-field">
            <label for="folder">Folder</label>
            <select id="folder" name="folder" required>
              {% for folder in report_folders %}
                <option value="{{ folder }}">{{ folder }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field wide">
            <label for="file">File</label>
            <input type="file" name="file" id="file" required />
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </section>

  <!-- ══════════════════════════════════
       04 · DELETE REPORT
       ══════════════════════════════════ -->
  <section class="admin-section">
    <div class="section-header">
      <span class="section-num">04</span>
      <span class="section-title">Delete Report</span>
    </div>
    <div class="section-body">
      <form action="/delete_report" method="post"
            onsubmit="return confirm('Permanently delete this report?')">
        <div class="form-grid">
          <div class="form-field">
            <label for="delete_folder">Folder</label>
            <select id="delete_folder" name="delete_folder">
              <option value="">— Root —</option>
              {% for folder in report_folders %}
                <option value="{{ folder }}">{{ folder }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field wide">
            <label for="delete_file">Filename</label>
            <input type="text" id="delete_file" name="delete_file"
                   placeholder="e.g. 2025-01 Monthly Report.pdf" />
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-danger">Delete Report</button>
        </div>
      </form>
    </div>
  </section>

  <!-- ══════════════════════════════════
       05 · DANGER ZONE
       ══════════════════════════════════ -->
  <section class="admin-section">
    <div class="section-header">
      <span class="section-num">05</span>
      <span class="section-title">Danger Zone</span>
    </div>
    <div class="section-body">
      <div class="danger-grid">

        <div class="danger-item">
          <span class="danger-item-label">Rebuild Cache</span>
          <span class="danger-item-desc">Recompute dashboard data from scratch.</span>
          <form action="/cache" method="get" style="margin-top:8px;">
            <button type="submit" class="btn btn-ghost">Rebuild Cache</button>
          </form>
        </div>

        <div class="danger-item">
          <span class="danger-item-label">Incremental Update</span>
          <span class="danger-item-desc">Fetch latest prices and update portfolio.</span>
          <form action="/increment" method="get" style="margin-top:8px;">
            <button type="submit" class="btn btn-ghost">Run Increment</button>
          </form>
        </div>

        <div class="danger-item">
          <span class="danger-item-label">Reset Database</span>
          <span class="danger-item-desc">Wipe the database entirely. Cannot be undone.</span>
          <form action="/reset_db" method="get"
                onsubmit="return confirm('Reset the entire database? This cannot be undone.')"
                style="margin-top:8px;">
            <button type="submit" class="btn btn-danger-solid">Reset Database</button>
          </form>
        </div>

      </div>
    </div>
  </section>

</main>
{% endblock %}

{% block footer_center %}{% endblock %}
{% block footer_meta %}Admin Interface &nbsp;·&nbsp; Restricted Access{% endblock %}

{% block body_scripts %}
<script>
let sortCol = -1, sortAsc = true;

function filterTable() {
  const query  = document.getElementById('tx-search').value.toLowerCase();
  const typeF  = document.getElementById('tx-type-filter').value.toLowerCase();
  const rows   = document.querySelectorAll('#tx-body tr');
  let visible  = 0;

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const text  = Array.from(cells).map(c => c.textContent).join(' ').toLowerCase();
    const type  = cells[3] ? cells[3].textContent.toLowerCase() : '';
    const match = text.includes(query) && (typeF === '' || type === typeF);
    row.style.display = match ? '' : 'none';
    if (match) visible++;
  });

  document.getElementById('tx-visible-count').textContent = visible + ' shown';
}

function sortTable(colIdx) {
  const tbody = document.getElementById('tx-body');
  const rows  = Array.from(tbody.querySelectorAll('tr'));
  const ths   = document.querySelectorAll('#tx-table thead th');

  sortAsc = (sortCol === colIdx) ? !sortAsc : true;
  sortCol = colIdx;

  ths.forEach((th, i) => {
    th.classList.toggle('sorted', i === colIdx);
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.textContent = (i === colIdx) ? (sortAsc ? '↑' : '↓') : '↕';
  });

  rows.sort((a, b) => {
    const av = a.querySelectorAll('td')[colIdx]?.textContent.trim() ?? '';
    const bv = b.querySelectorAll('td')[colIdx]?.textContent.trim() ?? '';
    const an = parseFloat(av.replace(/[^0-9.-]/g, ''));
    const bn = parseFloat(bv.replace(/[^0-9.-]/g, ''));
    const cmp = (!isNaN(an) && !isNaN(bn)) ? (an - bn) : av.localeCompare(bv);
    return sortAsc ? cmp : -cmp;
  });

  rows.forEach(r => tbody.appendChild(r));
}

document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById('date');
  if (dateInput && !dateInput.value) {
    dateInput.value = new Date().toISOString().split('T')[0];
  }
});
</script>
{% endblock %}
